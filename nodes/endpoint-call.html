<script type="text/javascript">
    RED.nodes.registerType('endpoint-call', {
        category: 'thinger',
        color: '#1e8cfb',
        defaults: {
            name: {value:""},
            endpoint: {value: ""},
            server: {type:"thinger-server", required:true}
        },
        icon:"server.svg",
        inputs: 1,
        outputs: 1,
        align: 'left',
        label: function() {
            return this.name || (this.endpoint ? this.endpoint : "endpoint call");
        },
        paletteLabel: function() {
            return "endpoint call";
        },
        oneditprepare: function() {

            const node_id = this.id;

            // Event handlers and requests
            $("#node-input-endpoint").focus(function() {
                if ($(".red-form-options").length && $(".red-form-options").prev()[0].id === $(this)[0].id) return;

                const field = "endpoint";
                const endpoint = $(this).val();
                const svr_id = $('#node-input-server').find(":selected")[0].value; // extracted each time to account for changes of the server field
                let endpoints = new ThingerEndpoints(endpoint,node_id,svr_id);
                endpoints.getEndpoints().then(function(data) {
                    ThingerDOM.showOptions(field, data, endpoint, function(value) {
                        // endpoints filtering callback
                        endpoints = new ThingerEndpoints(value,node_id,svr_id);
                        endpoints.getEndpoints().then((data) => {ThingerDOM.showOptions(field,data)});
                    });
                });
            });

        }
    });
</script>

<script type="text/x-red" data-template-name="endpoint-call">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-endpoint"><i class="fa fa-server"></i> Endpoint</label>
        <input type="text" id="node-input-endpoint" placeholder="Endpoint Identifier">
    </div>
    <div class="form-row">
        <label for="node-input-server"><i class="fa fa-server"></i> Server</label>
        <input type="text" id="node-input-server" placeholder="Select Server">
    </div>
</script>

<script type="text/markdown" data-help-name="endpoint-call">
Calls a server endpoint with the supplied input payload.

### Inputs

: endpoint (string) : the id of the endpoint to call.
: payload (string) : the payload of the message to send.

### Outputs

1. Standard output
: payload (object) : the standard output of the command.

2. Standard error
: payload (string) : the standard error of the command.

### Details
The node allows the configuration of the endpoint via the edit dialog or through an input message.
The values assigned through the dialog will have priority over the message.

The input `msg.payload` is not available through the edit dialog and can only be passed through the input.

### References

- [Thinger Node-RED Plugin]("https://docs.thinger.io/plugins/node-red") - full description of the plugin
- [GitHub]("https://github.com/thinger-io/Node-RED") - the nodes github repository
- [npm]("https://www.npmjs.com/package/node-red-contrib-thinger") - the nodes npm repository
- [Thinger.io]("https://thinger.io/") - the company behind the development
</script>
